# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           gitlab 1.0
PortGroup           muniversal 1.1

gitlab.instance     https://salsa.debian.org
gitlab.setup        rousseau PCSC 2.0.0
revision            0

name                pcsclite
categories          security
platforms           darwin
maintainers         {@gcenx}
license             GPL-3

description         Middleware to access a smart card using SCard API
long_description    {*}${description}

homepage            https://pcsclite.apdu.fr

distname            pcsc-lite-${version}
extract.suffix      .tar.bz2

worksrcdir          ${workpath}/${distname}

master_sites        ${homepage}/files/
use_bzip2           yes

checksums \
    rmd160  67ee92620fc4be554290f2b04c5aef573d2705ae \
    sha256  d6c3e2b64510e5ed6fcd3323febf2cc2a8e5fda5a6588c7671f2d77f9f189356 \
    size    799011

depends_build \
    bin:flex:flex

patch.pre_args -p1

configure.args \
    --disable-libsystemd \
    --enable-ipcdir=/var/run/pcscd \
    --enable-usbdropdir=${prefix}/libexec/SmartCardServices/drivers

post-destroot {
    ui_msg "--->  Installing Apples ifd-ccid.bundle into place"
    xinstall -d ${destroot}${prefix}/libexec/SmartCardServices/drivers
    file copy /usr/libexec/SmartCardServices/drivers/ifd-ccid.bundle ${destroot}${prefix}/libexec/SmartCardServices/drivers
}

variant libusb description {Build ${subport} with libusb} {
    depends_lib-append      port:libusb
    patchfiles-append       0001-configure-Allow-libusb-on-macOS.diff
    configure.args-append   --enable-libusb
}

notes "
    USB drop directory:     ${prefix}/libexec/SmartCardServices/drivers
"
